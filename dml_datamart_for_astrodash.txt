SQL

CREATE TABLE astro.dm_dashboard_main AS
WITH raw_data AS (
    SELECT 
        r.ProductId,
        r.Rid,
        r.Phid,
        r.Quantity,
        r.Amount,
        DATE(r.Date) as Date,
        DATE_TRUNC('month', r.Date)::DATE as Month,
        EXTRACT(YEAR FROM r.Date) as Year,
        EXTRACT(MONTH FROM r.Date) as Month_Num,
        EXTRACT(DOW FROM r.Date) as Day_Of_Week,
        TO_CHAR(r.Date, 'Month') as Month_Name,
        TO_CHAR(r.Date, 'Mon') as Month_Short_Name,
        TO_CHAR(r.Date, 'YYYY-MM') as Year_Month, -- для фильтра "список по месяцам"
        TO_CHAR(r.Date, 'Mon YYYY') as Month_Year_Display,
        COALESCE(NULLIF(c.chain, 'нет'), 'Несетевая') as Chain_Type,
        c.chain as Chain_Original,
        c.phname as Pharmacy_Name,
        p.pgroup as Product_Group,
        p.name as Product_Name,
        p.packsize as Pack_Size,
        reg.rname as Region_Name,
        reg.fd as Federal_District,
        reg.population as Population,
        reg.salary as Avg_Salary,
        cases.cases as Daily_Cases      
    FROM astro.raw r
    LEFT JOIN astro.chains c ON r.Phid = c.phid
    LEFT JOIN astro.products p ON r.ProductId = p.productid
    LEFT JOIN astro.regions reg ON r.Rid = reg.rid
    LEFT JOIN astro.cases_2024 cases ON r.Date = cases.dd
)
SELECT 
    *,
    COALESCE(Amount / NULLIF(Quantity, 0), 0) as Price_Per_Pack,
FROM raw_data;

CREATE INDEX idx_dm_main_year_month ON astro.dm_dashboard_main(Year_Month);
CREATE INDEX idx_dm_main_product_name ON astro.dm_dashboard_main(Product_Name);
CREATE INDEX idx_dm_main_region_name ON astro.dm_dashboard_main(Region_Name);
CREATE INDEX idx_dm_main_chain_type ON astro.dm_dashboard_main(Chain_Type);
CREATE INDEX idx_dm_main_pack_size_name ON astro.dm_dashboard_main(Pack_Size_Name);
CREATE INDEX idx_dm_main_composite ON astro.dm_dashboard_main(Date, Rid, ProductId, Chain_Type); 
